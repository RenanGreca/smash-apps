<!--
By Renan Greca in 2017
https://github.com/RenanGreca/smash-apps

Based heavily on Tier List Maker by quetzle
https://github.com/quetzle/smash-apps

-->

<!doctype html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href= "../icon.png"/>
    <title>Tier List Maker - Smash Apps</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,100italic" rel="stylesheet" type="text/css">
    <link href="newstyle.css" rel="stylesheet">
    <link href="dragula.min.css" rel="stylesheet">
</head>
<body>
<div id="controls">
    <h1>TIER LIST MAKER</h1>
    <div id="buttons">
        <button id="screenshot">Share</button>
        <button id="hidebuttons">Hide controls</button>
        <!--<button id="game">Change game</button>-->
        <button id="help">Help</button>
        <button id="reset">Reset</button>
    </div>
</div>

<div id="tablewrap"><table><tbody>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">S</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">A</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">B</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">C</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">D</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">E</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
<tr>
    <td class="labelHolder" contenteditable="true"><span class="label">F</span></td>
    <td><div class="tier sort" id="rows"></div></td>
    <td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
</tr>
</tbody></table>
</div>

<div class='character'><img src="img/add.png" onClick="addItem()" /></div>
<div id="char" class="sort">

</div>

<div id="overlay">
    <div id="modalWrapper">
        <div id="modal">
            <h1>SETTINGS</h1>
            <span id="close"></span>
            <p>Choose label color:</p>
            <div id="colorselect"><span style="background:#FF7F7F"></span><span style="background:#FFBF7F"></span><span style="background:#FFDF7F"></span><span style="background:#FFFF7F"></span><span style="background:#BFFF7F"></span><span style="background:#7FFF7F"></span><span style="background:#7FFFFF"></span><span style="background:#7FBFFF"></span><span style="background:#7F7FFF"></span><span style="background:#FF7FFF"></span><span style="background:#BF7FBF"></span><span style="background:#3B3B3B"></span><span style="background:#858585"></span><span style="background:#CFCFCF"></span><span style="background:#F7F7F7"></span></div>
            <p>Label name:</p><textarea id="labelName"></textarea>
            <p>Row functions:</p>
            <p><button id="deleteRow">Delete row</button> <button id="clearRow">Clear row</button></p>
            <p><button id="addRowUp">Add row above</button> <button id="addRowBelow">Add row below</button></p>
        </div>
        <div id="helpMenu">
            <h1>HELP</h1>
            <span id="close"></span>
            <p>This is the new version of the old Smash Tier List Maker. If you still like the old one, <a href="old/">click here</a> to go there.</p>
            <p><strong>All 4 official Smash games and Project M are supported.</strong> If you want to change the game you are using, click on "Change game" in the top bar.</p>
            <p><strong>You can take screenshots of your tierlist.</strong> To take a screenshot, click on the "Share" button in the top bar. A popup should appear that contains an image of your tierlist. You can copy or save this image to then upload to an image hosting site. If the screenshot feature does not work for you, you can click the "Hide controls" button to make the list look cleaner.</p>
            <p><strong>You can share editable versions of your tierlist.</strong> Click on the "Share" button and you will see a textbox that contains a code. Copy and share this with others so that they can edit your tierlist.</p>
            <p><strong>Your latest tierlist autosaves to your device.</strong> As soon as you drag a character image, your tierlist will be saved. Any time you reopen it you will be able to access your previous tierlist.</p>
            <p>There is a gear next to each tier in the tierlist. (If you don't see this gear, click on the "Toggle screenshot mode" button in the top bar. If this doesn't work, <a href="https://www.reddit.com/message/compose?to=Buizbuiz&subject=Smash%20Tier%20List%20Maker">message /u/Buizbuiz on reddit</a>.) If you click on it, you can <strong>change the color of the tier label, add rows, delete the row, or remove all of the characters currently in the row.</strong></p>
            <p>Next to the gear are 2 arrows, pointed up and down. Clicking these will let you <strong>move a tier up and down a level</strong>.</p>
            <p><strong>You can change the name of the tier.</strong> Click on the tier label, you can type in there. If this doesn't work, you can change it in the textbox in the corresponding settings menu.</p>
            <p>If you want to <strong>completely start over</strong>, just refresh the page.</p>
        </div>
        <div id="screenshotShow">
            <span id="close"></span>
            <p>Your image should appear above. You can copy or save this image. Try uploading it to an image hosting website such as <a href="http://imgur.com">Imgur</a>. Alternatively, copy the code below to share an editable version of your tierlist. Just paste a code into the box below and click "Run code" to access it.</p>
            <textarea id="exportcode" cols="30" rows="8"></textarea><div><button id="runCode">Run code</button></div>
        </div>
        <div id="addItem">
            <h1>ADD ITEM</h1>
            <span id="close"></span>
            <p>Item name:</p><input type="text" id="itemName" />
            <p>Item image:</p><input type="file" name="file" id="image" /><br/>
            <img id="preview" />
            <!--<div id="filezone"></div>--><br/><br/>
            <button id="addItemSubmit" >Submit</button>
        </div>
    </div>
</div>
<script src="./jquery.js"></script>
<script src="dragula.min.js"></script>
<script src="html2canvas.js"></script>
<!--<script src="./dropzone.js"></script>-->
<script type="text/javascript">

    dragula({
        isContainer: function (el) {
            return el.classList.contains('sort');
        }
    });

    var singleTier = "<tr><td class='labelHolder' contenteditable='true' style='background-color:#FFFF7F'><span class='label'>NEW</span></td><td><div class='tier sort' id='rows'><div class='hiddenkid'></div></div></td><td><div id='settings'></div><div id='moveButtons'><div id='moveUp'></div><div id='moveDown'></div></div></td></tr>";

    var screenshotMode = false;
    // first is the row in the table of the tier, second is the index of its color
    var tierDefaults = [ [$("tr:nth-of-type(1)"), 0],
        [$("tr:nth-of-type(2)"), 1],
        [$("tr:nth-of-type(3)"), 3],
        [$("tr:nth-of-type(4)"), 5],
        [$("tr:nth-of-type(5)"), 7],
        [$("tr:nth-of-type(6)"), 8],
        [$("tr:nth-of-type(7)"), 9] ];
    var items = [];
    var tier = [];
    var currentFile = null;
    var currentTier;
    var tempTier;
    var tierIndex;
    var currentColor;
    var colorIndex;

    var colors = ["#FF7F7F","#FFBF7F","#FFDF7F","#FFFF7F","#BFFF7F","#7FFF7F","#7FFFFF","#7FBFFF","#7F7FFF","#FF7FFF","#BF7FBF","#3B3B3A","#858585","#CFCFCF","#F7F7F7"];

    for (var i = 0; i < tierDefaults.length; i++) {
        tierDefaults[i][0].find(".labelHolder").css("background",colors[tierDefaults[i][1]]);
    }

    function addItem() {
        $("#addItem").css("display","block");
        $("#overlay").css("opacity", 1);
        $("#overlay").css("visibility", "visible");
        $("#addItem").css("top",alignPopup($("#addItem")));
    }

    // Thanks to http://stackoverflow.com/a/18457508
    $('#image').change(function(){
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                currentFile = e.target.result;
                $('#preview').attr('src', e.target.result);
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    $('#addItemSubmit').click(function() {
        var item = {
            name: $('#itemName').val(),
            img: currentFile
        };
        items.push(item);

        $("#addItem").css("display","none");
        $("#overlay").css("opacity", 0);
        $("#overlay").css("visibility", "hidden");
        console.log($("#addItem").css('display'));

        var html = "<div class='character'><img src='"+item.img+"'/></div>";
        $('#char').append(html);
    });

    $(document).on("click", "#settings", function() { // open settings modal
        currentTier = $(this).parent().parent();
        currentColor = currentTier.find(".labelHolder").css("background-color");
        $("textarea").val(currentTier.find(".labelHolder").text());
        colorIndex = colors.indexOf(rgb2hex(currentColor).toUpperCase());
        tier = [currentTier, colorIndex];
        for (var i = 0; i < $("#modal span").length; i++) {
            $("#modal span:nth-of-type("+(i+1)+")").attr("class","nope");
        }
        $("#modal span:nth-of-type("+(colorIndex+1)+")").attr("class","selected");
        $("#modal").css("display","block");
        $("#overlay").css("opacity", 1);
        $("#overlay").css("visibility", "visible");
        $("#modal").css("top",alignPopup($("#modal")));
    });

    $(document).on("click", "#help", function() { // open help modal
        $("#helpMenu").css("display","block");
        $("#overlay").css("opacity", 1);
        $("#overlay").css("visibility", "visible");
        $("#helpMenu").css("top",alignPopup($("#helpMenu")));
    });

    $(document).on("click", "#colorselect span", function() { // change row label
        for (var i = 0; i < $("#modal span").length; i++) {
            $("#modal span:nth-of-type("+(i+1)+")").attr("class","nope");
        }
        $(this).attr("class","selected");
        currentTier.find(".labelHolder").css("background-color",$(this).css("background-color"));
        updateTiers();
    });

    $("#labelName").bind("input propertychange", function() {
        currentTier.find(".label").html($("#labelName").val().replace(/\n/g, "<br>"));
    });

    $(document).on("click", "#colorselect span", function() { // change row label
        for (var i = 0; i < $("#modal span").length; i++) {
            $("#modal span:nth-of-type("+(i+1)+")").attr("class","nope");
        }
        $(this).attr("class","selected");
        currentTier.find(".labelHolder").css("background-color",$(this).css("background-color"));
        updateTiers();
    });

    $(document).on("click", function(e) {
        clicked = e.target.id;
        if (clicked == "overlay" || clicked == "modalWrapper" || clicked == "close") { // close modals
            $("#overlay").css("opacity", 0);
            $("#overlay").css("visibility", "hidden");
            $("#modal").css("display", "none");
            $("#addItem").css("display","none");
            $("#gameChange").css("display", "none");
            $("#helpMenu").css("display", "none");
            $("#screenshotShow").css("display", "none");
        } else if(clicked == "screenshot") { // take a screenshot
//            $("#exportcode").val(toCode());
            $("#modal").css("display", "none");
            $("#gameChange").css("display", "none");
            $("#helpMenu").css("display", "none");
            $("#screenshotShow canvas").remove();
            $("#screenshotShow").css("display","block");
            $("#overlay").css("opacity", 1);
            $("#overlay").css("visibility", "visible");
            $("td:last-of-type").css("display","none");
            html2canvas($("table"), {
                onrendered: function(canvas) {
                    $("#screenshotShow span").after(canvas);
                    $("td:last-of-type").css("display","table-cell");
                    $("#screenshotShow").css("top",alignPopup($("#screenshotShow")));
                }
            });
        } else if(clicked == "hidebuttons") { // hide the buttons
            if (screenshotMode) {
                $("td:last-of-type").css("display","table-cell");
                $("#hidebuttons").text("Hide controls");
                screenshotMode = false;
            } else {
                $("td:last-of-type").css("display","none");
                $("#hidebuttons").text("Show controls");
                screenshotMode = true;
            }
        } else if (clicked == "addRowUp") { // add a row on top of the current row
            $("tr:nth-of-type("+($("tr").index(currentTier)+1)+")").before(singleTier);
            updateTiers();
        } else if (clicked == "addRowBelow") { // add a row below the current row
            $("tr:nth-of-type("+($("tr").index(currentTier)+1)+")").after(singleTier);
            updateTiers();
        } else if (clicked == "moveUp") { // move the row above the row above it
            currentTier = $(e.target).closest("tr");
            if (currentTier.prev("tr").length != 0)
                currentTier.insertBefore(currentTier.prev("tr"));
        } else if (clicked == "moveDown") { // move the row below the row below it
            currentTier = $(e.target).closest("tr");
            if (currentTier.next("tr").length != 0)
                currentTier.insertAfter(currentTier.next("tr"));
        } else if (clicked == "runCode") {
//            loadCode($("#exportcode").val());
        } else if (clicked == "reset") {
//            loadCode(items[0]+"==S|0==A|1==B|3==C|5==D|7==E|8==F|9");
        }
    });

    function updateTiers() {
        tierlist = [];
        tempTier = currentTier;
        for (var i = 0; i < $("tr").length; i++) {
            currentTier = $("tr:nth-of-type("+(i+1)+")");
            currentColor = currentTier.find(".labelHolder").css("background-color"); // returns in rgb format, have to convert to hex
            tier[0] = currentTier;
            tier[1] = colors.indexOf(rgb2hex(currentColor).toUpperCase());
            tierlist.push(tier);
        }
        currentTier = tempTier;
    }

    function tierlistSize() {
        if ($("table").width > $("#tablewrap").width)
            $("#tablewrap").css("display","table-cell");
        else
            $("#tablewrap").css("display","block");
    }

    // thanks to http://stackoverflow.com/a/3971432
    function rgb2hex(rgb) {
        rgb = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);
        function hex(x) {
            return ("0" + parseInt(x).toString(16)).slice(-2);
        }
        return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
    }

    function alignPopup(popup) {
        return Math.floor(($(window).height() - popup.height())/2)+"px";
    }

    $(document).ready( function() {
        updateTiers();
        tierlistSize();
    });
    $(window).resize( function () {
        tierlistSize();
    });

//    var dropzone = new Dropzone('div#filezone');
</script>
</body>
